<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcomOps AI | Command Center</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div class="sidebar">
        <button class="new-chat-btn" onclick="startNewChat()">+ New Chat</button>
        <div class="history-label">Recent History</div>
        <div id="history-list" class="history-list"></div>
        
        <button class="theme-toggle" onclick="toggleTheme()">
            <span id="theme-icon">üåô</span> <span id="theme-text">Dark Mode</span>
        </button>
    </div>

        <div class="main-content">
        <header class="top-nav">
            <div class="model-info">
                <span class="model-badge">EcomOps v1.0</span>
            </div>
            
            <div class="profile-trigger" onclick="openProfile()">
                <div class="mgr-info">
                    <span id="mgr-display-name">Manager Name</span>
                    <small id="mgr-display-email">manager@ecomops.ai</small>
                </div>
                <div class="avatar-circle" id="nav-avatar">M</div>
            </div>
        </header>

        <div id="chat-window" class="chat-window"></div>

        <div class="input-wrapper">
            <div class="input-box">
                <textarea id="user-input" rows="1" placeholder="Ask EcomOps Agent anything..." oninput="autoGrow(this)"></textarea>
                <button class="send-btn" id="send-btn" onclick="send()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>
    </div>

   <div id="profile-overlay" class="modal-overlay" onclick="closeProfile(event)">
    <div class="gemini-profile-card" onclick="event.stopPropagation()">
        <div class="gemini-identity">
            <div class="gemini-avatar-wrapper">
                <div class="avatar-huge" id="modal-avatar">M</div>
                <button class="avatar-edit-icon">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                </button>
            </div>
            <h2 id="profile-name">Manager Name</h2>
            <p id="profile-email">manager@ecomops.ai</p>
            <button class="manage-account-btn">Manage your EcomOps Account</button>
        </div>

        <div class="gemini-settings-box">
            <div class="gemini-input-group">
                <input type="password" id="new-password" placeholder="Change password" oninput="checkNewPasswordStrength()">
                <button class="gemini-update-btn" id="update-pass-btn" onclick="saveProfile()" disabled>Update</button>
            </div>
            <div class="strength-meter-mini"><div id="profile-strength-bar"></div></div>
        </div>

        <div class="gemini-actions">
            <button class="gemini-action-pill" onclick="logout()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                Sign out
            </button>
        </div>

        <div class="gemini-footer-links">
            <span>Privacy Policy</span> ‚Ä¢ <span>Terms of Service</span>
        </div>
    </div>
</div>

    <script>
    const urlParams = new URLSearchParams(window.location.search);
    const MANAGER_ID = localStorage.getItem('current_manager_id');
    const managerName = localStorage.getItem('current_manager_name') || "Manager";
    const DYNAMIC_AGENT_ID = urlParams.get('agent') || "ecomops_master";
    let convId = null;

    function scrollToBottom() {
    const chatWindow = document.getElementById('chat-window');
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

function autoGrow(element) {
    element.style.height = "5px"; // Reset height to recalculate
    element.style.height = (element.scrollHeight) + "px";
}
     document.addEventListener('click', function(e) {
        const btn = e.target.closest('.action-btn');
        if (!btn) return;

        // Use the handleAction logic but triggered via this listener
        const actionType = btn.getAttribute('data-action');
        const targetId = btn.getAttribute('data-target');
        const contentEl = document.getElementById(targetId);

        if (!contentEl) return;

        if (actionType === 'copy') {
            const textToCopy = contentEl.innerText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = "‚úÖ Copied!";
                setTimeout(() => { btn.innerHTML = originalHTML; }, 1500);
            });
        } 
        else if (actionType === 'edit') {
            const inputField = document.getElementById('user-input');
            inputField.value = contentEl.innerText;
            inputField.focus();
            autoGrow(inputField);
            // Visual feedback
            inputField.style.boxShadow = "0 0 0 2px var(--accent-primary)";
            setTimeout(() => { inputField.style.boxShadow = ""; }, 1000);
        }
    });

    if (!MANAGER_ID) {
        alert("‚ùå No Manager ID found. Redirecting to registration.");
        window.location.href = 'form.html'; 
    }

    window.onload = () => {
        loadManagerThreads();
        startNewChat();
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') toggleTheme();
    };

    function checkNewPasswordStrength() {
    const pass = document.getElementById('new-password').value;
    const bar = document.getElementById('profile-strength-bar');
    const btn = document.getElementById('update-pass-btn');
    
    // Requirements: 8 chars, 1 uppercase, 1 number, 1 symbol
    const hasLen = pass.length >= 8;
    const hasSpecial = /[A-Z]/.test(pass) && /[0-9]/.test(pass) && /[^A-Za-z0-9]/.test(pass);

    // Update Strength Bar Width
    let score = 0;
    if (hasLen) score += 50;
    if (hasSpecial) score += 50;
    
    bar.style.width = score + "%";
    bar.style.background = score === 100 ? "#10a37f" : "#f59e0b";

    // IMPORTANT: This enables the button
    btn.disabled = !(hasLen && hasSpecial);
}
    async function loadManagerThreads() {
        const res = await fetch(`http://127.0.0.1:8000/api/v1/threads/${MANAGER_ID}`);
        const data = await res.json();
        renderSidebar(data.threads);
    }


    // Function to update UI with Manager's Initial
function updateSidebarUI() {
    const name = localStorage.getItem('current_manager_name') || "Manager";
    const initial = name.charAt(0).toUpperCase();
    
    // Update the text and the avatar initial
    const nameEl = document.getElementById('mgr-display-name');
    const avatarEl = document.getElementById('top-avatar');
    
    if (nameEl) nameEl.innerText = name;
    if (avatarEl) avatarEl.innerText = initial;
}
async function openProfile() {
    // Show the modal first
    document.getElementById('profile-overlay').style.display = 'flex';
    
    try {
        const res = await fetch(`http://127.0.0.1:8000/api/v1/manager/profile/${MANAGER_ID}`);
        const data = await res.json();
        
        if (res.ok) {
            document.getElementById('profile-name').innerText = data.full_name;
            document.getElementById('profile-email').innerText = data.email;
            // You could also add a company name field to your modal if you like!
        }
    } catch (err) {
        console.error("Could not load profile:", err);
    }
}

function closeProfile(e) {
    document.getElementById('profile-overlay').style.display = 'none';
}

function logout() {
    if(confirm("Are you sure you want to log out?")) {
        localStorage.removeItem('current_manager_id');
        localStorage.removeItem('current_manager_name');
        window.location.href = 'login.html';
    }
}

async function saveProfile() {
    const newPassword = document.getElementById('new-password').value;
    const managerId = localStorage.getItem('current_manager_id');
    const btn = document.getElementById('update-pass-btn');

    // 1. Visual feedback
    btn.innerText = "Updating...";
    btn.disabled = true;

    try {
        const response = await fetch(`http://127.0.0.1:8000/api/v1/manager/update-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                manager_id: managerId,
                new_password: newPassword
            })
        });

        const data = await response.json();

        if (response.ok) {
            alert("Password updated successfully!");
            document.getElementById('new-password').value = ""; // Clear input
            closeProfile(); // Close the Gemini modal
        } else {
            alert("Error: " + data.detail);
        }
    } catch (error) {
        console.error("Update failed:", error);
        alert("Server connection failed.");
    } finally {
        btn.innerText = "Update";
        btn.disabled = false;
    }
}
        // Update the window.onload to include UI update
        const originalOnload = window.onload;
        window.onload = () => {
            if(originalOnload) originalOnload();
            updateSidebarUI();
        };
    // --- CONSOLIDATED MESSAGE RENDERING (Fixes the conflict) ---
    function renderMessageRow(text, role, id = null) {
        const chatWindow = document.getElementById('chat-window');
        const msgId = id || "msg-" + Date.now() + Math.random().toString(16).slice(2);
        const row = document.createElement('div');
        row.className = `message-row ${role === 'user' ? 'user-row' : 'ai-row'}`;
        
        // We use data-attributes instead of onclick to work with the listener above
        const copyBtn = `<button class="action-btn" data-action="copy" data-target="${msgId}"><span>üìã</span> Copy</button>`;
        const editBtn = role === 'user' ? `<button class="action-btn" data-action="edit" data-target="${msgId}"><span>‚úèÔ∏è</span> Edit</button>` : '';

        row.innerHTML = `
            <div class="avatar">${role === 'user' ? 'U' : 'AI'}</div>
            <div class="msg-container" style="max-width: 80%;">
                <div class="content" id="${msgId}">${role === 'user' ? text : marked.parse(text)}</div>
                <div class="message-actions">${editBtn}${copyBtn}</div>
            </div>
        `;
        
        chatWindow.appendChild(row);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return msgId;
    }

    // Action Handler
    function handleAction(type, id) {
        const el = document.getElementById(id);
        if (!el) return;

        if (type === 'copy') {
            const textToCopy = el.innerText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const btn = event.currentTarget;
                const originalText = btn.innerHTML;
                btn.innerHTML = "‚úÖ Copied!";
                setTimeout(() => btn.innerHTML = originalText, 1500);
            });
        } 
        else if (type === 'edit') {
            const inputField = document.getElementById('user-input');
            inputField.value = el.innerText;
            inputField.focus();
            autoGrow(inputField);
        }
    }

    // Helper for live messages (used in send function)
    function addMsg(text, sender, isThinking = false) {
        const msgId = renderMessageRow(isThinking ? 'AI is processing...' : text, sender);
        if (isThinking) document.getElementById(msgId).classList.add('typing');
        return msgId;
    }

    function updateMsg(id, text) {
        const el = document.getElementById(id);
        if (el) {
            el.classList.remove('typing');
            el.innerHTML = marked.parse(text);
            document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
        }
    }

    // --- SIDEBAR & THEME ---
    function renderSidebar(threads) {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        threads.forEach(thread => {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.id = `item-${thread.id}`;
            item.innerHTML = `<span>${thread.title}</span>`; 
            item.onclick = () => loadChat(thread.id);
            list.appendChild(item);
        });
    }

    async function loadChat(id) {
        convId = id;
        document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
        const activeItem = document.getElementById(`item-${id}`);
        if(activeItem) activeItem.classList.add('active');

        const chatWindow = document.getElementById('chat-window');
        chatWindow.innerHTML = '<div class="typing">Syncing with database...</div>';

        try {
            const res = await fetch(`http://127.0.0.1:8000/api/v1/history/${id}`);
            const data = await res.json();
            chatWindow.innerHTML = ''; 
            data.history.forEach(msg => renderMessageRow(msg.content, msg.role));
        } catch (error) {
            chatWindow.innerHTML = '<div class="content">‚ö†Ô∏è Failed to load.</div>';
        }
    }

    function startNewChat() {
        convId = 'conv_' + Date.now();
        document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
        const chatWindow = document.getElementById('chat-window');
        chatWindow.innerHTML = '';
        renderMessageRow("New session started. I'm ready for your next command.", 'ai');
    }

    async function send() {
        const inputField = document.getElementById('user-input');
        const text = inputField.value.trim();

        function scrollToBottom() {
            const chatWindow = document.getElementById('chat-window');
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        if (!text) return;
        
        renderMessageRow(text, 'user');
        inputField.value = '';
        autoGrow(inputField);

        const aiMsgId = addMsg('Thinking...', 'ai', true);
        const idToSend = (convId && convId.startsWith('conv_')) ? null : convId;

        try {
            const res = await fetch('http://127.0.0.1:8000/api/v1/converse', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    prompt: text, 
                    conversation_id: idToSend, 
                    manager_id: String(MANAGER_ID),
                    manager_name: managerName,
                    agent_id: DYNAMIC_AGENT_ID
                })
            });

            const data = await res.json();
            if (data.conversation_id) convId = data.conversation_id;
            updateMsg(aiMsgId, data.response?.message || "Processed.");
            loadManagerThreads(); 
        } catch (error) {
            updateMsg(aiMsgId, `‚ö†Ô∏è ${error.message}`);
        }
    }

    function autoGrow(element) {
        element.style.height = "5px";
        element.style.height = (element.scrollHeight) + "px";
    }

    document.getElementById('user-input').addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });

    function toggleTheme() {
        const body = document.body;
        if (body.getAttribute('data-theme') === 'dark') {
            body.removeAttribute('data-theme');
            localStorage.setItem('theme', 'light');
        } else {
            body.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
        }
    }

   async function loadManagerDetails() {
    const managerId = localStorage.getItem('current_manager_id');
    if (!managerId) return;

    try {
        const response = await fetch(`http://127.0.0.1:8000/api/v1/manager/profile/${managerId}`);
        const data = await response.json();

        if (response.ok) {
            // 1. Update the Top Nav (Header)
            const navName = document.getElementById('mgr-display-name');
            const navEmail = document.getElementById('mgr-display-email');
            
            if(navName) navName.innerText = data.full_name;
            if(navEmail) navEmail.innerText = data.email; // Sets the small email in header

            // 2. Update the Profile Modal
            const modalName = document.getElementById('profile-name');
            const modalEmail = document.getElementById('profile-email');
            
            if(modalName) modalName.innerText = data.full_name;
            if(modalEmail) modalEmail.innerText = data.email; // Sets the email in the modal card

            // 3. Update Avatars
            const initial = data.full_name.charAt(0).toUpperCase();
            document.getElementById('nav-avatar').innerText = initial;
            document.getElementById('modal-avatar').innerText = initial;

        } else {
            console.error("Server returned error:", data.detail);
        }
    } catch (error) {
        console.error("Network Error:", error);
    }
}

// Call this when the window loads
window.onload = loadManagerDetails;

function logout() {
    // 1. Optional: Call backend to invalidate token if using blacklisting
    // const token = localStorage.getItem('token');
    // await fetch('http://127.0.0.1:8000/api/v1/logout', { method: 'POST', ... });

    // 2. Clear all sensitive manager data from storage
    const itemsToRemove = [
        'current_manager_id', 
        'current_manager_name', 
        'access_token', 
        'user_theme'
    ];
    
    itemsToRemove.forEach(item => localStorage.removeItem(item));

    // 3. Optional: Clear session storage if you used it for temporary chat history
    sessionStorage.clear();

    // 4. Redirect to login or landing page
    // We use replace() so the user cannot click 'Back' to return to the dashboard
    window.location.replace('login.html');
}

(function() {
    const managerId = localStorage.getItem('current_manager_id');
    if (!managerId) {
        // If no ID is found, they aren't logged in. Boot them out.
        window.location.replace('login.html');
    }
})();
</script>
</body>
</html>